Metadata-Version: 2.4
Name: task-queue
Version: 1.0.0
Summary: Task queue system for Claude Agent SDK execution
Author: DataChat Project
License: MIT
Project-URL: Homepage, https://github.com/datachat/task-queue
Project-URL: Repository, https://github.com/datachat/task-queue
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Programming Language :: Python :: 3.13
Requires-Python: >=3.11
Description-Content-Type: text/markdown
Requires-Dist: pydantic>=2.0.0
Requires-Dist: claude-agent-sdk>=0.1.0
Requires-Dist: watchdog>=4.0.0
Provides-Extra: dev
Requires-Dist: pytest>=7.0.0; extra == "dev"
Requires-Dist: pytest-cov>=4.0.0; extra == "dev"
Requires-Dist: black>=23.0.0; extra == "dev"
Requires-Dist: mypy>=1.0.0; extra == "dev"
Requires-Dist: ruff>=0.1.0; extra == "dev"

# Task Queue

A task monitoring and execution system that processes task specifications using the Claude Agent SDK. Features event-driven file monitoring with per-source queue architecture.

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Task Queue System                        â”‚
â”‚                     v2.0 - Per-Source Queues                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Source A Handler   â”‚  â”‚ Source B Handler   â”‚  â”‚ Source C Handler   â”‚   â”‚
â”‚   â”‚                    â”‚  â”‚                    â”‚  â”‚                    â”‚   â”‚
â”‚   â”‚ Watch: tasks/a/    â”‚  â”‚ Watch: tasks/b/    â”‚  â”‚ Watch: tasks/c/    â”‚   â”‚
â”‚   â”‚                    â”‚  â”‚                    â”‚  â”‚                    â”‚   â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚ â”‚ Queue (FIFO) â”‚  â”‚  â”‚ â”‚ Queue (FIFO) â”‚  â”‚  â”‚ â”‚ Queue (FIFO) â”‚  â”‚   â”‚
â”‚   â”‚ â”‚              â”‚  â”‚  â”‚ â”‚              â”‚  â”‚  â”‚ â”‚              â”‚  â”‚   â”‚
â”‚   â”‚ â”‚ task-a1      â”‚  â”‚  â”‚ â”‚ task-b1      â”‚  â”‚  â”‚ â”‚ task-c1      â”‚  â”‚   â”‚
â”‚   â”‚ â”‚ task-a2      â”‚  â”‚  â”‚ â”‚ task-b2      â”‚  â”‚  â”‚ â”‚ task-c2      â”‚  â”‚   â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚        â”‚           â”‚  â”‚        â”‚           â”‚  â”‚        â”‚           â”‚   â”‚
â”‚   â”‚        â–¼           â”‚  â”‚        â–¼           â”‚  â”‚        â–¼           â”‚   â”‚
â”‚   â”‚   Sequential One   â”‚  â”‚   Sequential One   â”‚  â”‚   Sequential One   â”‚   â”‚
â”‚   â”‚   at a Time       â”‚  â”‚   at a Time       â”‚  â”‚   at a Time       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚               Source Coordinator (Round-Robin)                â”‚   â”‚
â”‚   â”‚                                                            â”‚   â”‚
â”‚   â”‚   Execute A-1 â†’ Switch to B â†’ Execute B-1 â†’ Switch to C... â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                 Project Workspace (single)                  â”‚    â”‚
â”‚   â”‚                 /home/admin/workspaces/datachat            â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Concepts

| Concept | Term | Definition |
|---------|------|------------|
| **1** | **Task Source Directory** | A folder containing task document files. Watched for file changes. |
| **2** | **Task Document** | Individual task specification file (e.g., `task-YYYYMMDD-HHMMSS-description.md`). |
| **3** | **Project Workspace** | The working directory where Claude Agent SDK executes. |

## Features

### Core Features

| Feature | Description |
|---------|-------------|
| **Event-Driven** | Watchdog detects file changes instantly (no polling delay) |
| **Per-Source Queues** | Each Task Source Directory has its own queue and lock |
| **Sequential Within Source** | Tasks from same source execute one at a time (FIFO) |
| **Parallel Across Sources** | Different sources can execute simultaneously |
| **Round-Robin Coordinator** | Fair scheduling across all sources |
| **Auto-Load on Create** | Watchdog auto-loads new Task Documents |
| **Manual Load/Reload** | Explicit control via `load` and `reload` commands |
| **Unload by Source** | Remove all tasks from a specific source |
| **Atomic State Persistence** | Safe concurrent access with atomic file operations |
| **Claude Agent SDK Integration** | Executes tasks via `/task-worker` skill |
| **Daemon Service** | Runs as systemd user service for continuous processing |

### Execution Model

**Same source:** Sequential FIFO (task-a1 â†’ task-a2 â†’ task-a3)

**Different sources:** Parallel (A-1 and B-1 can run simultaneously)

### Safety Features

- **Atomic Writes**: State files use temporary file + atomic replacement
- **File Locking**: fcntl-based locks prevent concurrent modification
- **State Recovery**: Queue state persists across daemon restarts
- **Error Handling**: Failed tasks are tracked with error messages
- **Archive Preservation**: Completed task specs preserved in archive

## Installation

### From Source

```bash
cd /home/admin/workspaces/task-queue
pip install -e .
```

### Systemd Service

```bash
# Copy service file
cp task-queue.service ~/.config/systemd/user/

# Reload systemd
systemctl --user daemon-reload

# Enable at login
systemctl --user enable task-queue
```

## Quick Start

### 1. Load tasks from a Task Source Directory

```bash
task-queue load --task-source-dir tasks/task-documents --project-workspace /home/admin/workspaces/datachat --source-id main
# Output: âœ… Registered Task Source Directory 'main': tasks/task-documents
#         âœ… Loaded 1 new tasks
```

### 2. Create a Task Document

Create a file in your Task Source Directory following the naming pattern:
```
task-YYYYMMDD-HHMMSS-description.md
```

Example: `task-20260205-100000-fix-auth-timeout.md`

The watchdog will auto-detect and load the new task immediately.

### 3. Check status

```bash
task-queue status
```

### 4. Process tasks

```bash
# Manual processing
task-queue process

# Or start the daemon (with watchdog auto-loading)
systemctl --user start task-queue
```

## CLI Commands

### Task Operations

```bash
# Load tasks from Task Source Directory
task-queue load --task-source-dir <path> --project-workspace <path> --source-id <id>

# Load a single Task Document
task-queue load --task-source-dir tasks/task-documents/task-001.md --project-workspace /home/admin/workspaces/datachat --source-id main

# Force re-scan a Task Source Directory
task-queue reload --task-source-dir <source-id-or-path> --project-workspace <path>

# Remove ALL tasks from a Task Source Directory
task-queue unload --source-id <source-id>

# Process pending tasks
task-queue process [--max-tasks N]
```

### Monitoring

```bash
# Show system status
task-queue status [-v]

# Show queue status
task-queue queue

# List Task Source Directories
task-queue list-sources
```

### Interactive Mode

```bash
# Run monitor interactively
task-queue run [--cycles N]

# Cycles: 0 = infinite, N = specific number
```

## Configuration

Configuration file: `~/.config/task-queue/config.json`

```json
{
  "version": "1.0",
  "project_workspace": "/home/admin/workspaces/datachat",
  "task_source_directories": [
    {
      "id": "main",
      "path": "/home/admin/workspaces/datachat/tasks/task-documents",
      "description": "Main Task Source Directory",
      "added_at": "2026-02-05T10:00:00.000000"
    }
  ],
  "settings": {
    "watch_enabled": true,
    "watch_debounce_ms": 500,
    "watch_patterns": ["task-*.md"],
    "watch_recursive": false,
    "task_pattern": "task-*.md",
    "max_attempts": 3,
    "enable_file_hash": true
  },
  "created_at": "2026-02-05T10:00:00.000000",
  "updated_at": "2026-02-05T10:00:00.000000"
}
```

### Settings

| Setting | Default | Description |
|---------|---------|-------------|
| `watch_enabled` | true | Enable watchdog for file system events |
| `watch_debounce_ms` | 500 | Debounce delay in milliseconds for file events |
| `watch_patterns` | ["task-*.md"] | File patterns to watch |
| `watch_recursive` | false | Watch subdirectories |
| `task_pattern` | "task-*.md" | Pattern for task document files |
| `max_attempts` | 3 | Max execution attempts per task |
| `enable_file_hash` | true | Track file hashes for change detection |

## State Structure

### Queue State (v2.0)

State file: `~/.config/task-queue/state/queue_state.json`

```json
{
  "version": "2.0",
  "sources": {
    "main": {
      "id": "main",
      "path": "/path/to/source",
      "queue": [
        {
          "task_id": "task-20260205-100000-test",
          "task_doc_file": "/path/to/task.md",
          "task_doc_dir_id": "main",
          "status": "pending",
          "source": "watchdog",
          "attempts": 0
        }
      ],
      "processing": {
        "is_processing": false,
        "current_task": null,
        "process_id": null,
        "started_at": null,
        "hostname": null
      },
      "statistics": {
        "total_queued": 1,
        "total_completed": 0,
        "total_failed": 0,
        "last_processed_at": null,
        "last_loaded_at": "2026-02-05T10:00:00.000000"
      },
      "updated_at": "2026-02-05T10:00:00.000000"
    }
  },
  "coordinator": {
    "current_source": "main",
    "last_switch": "2026-02-05T10:00:00.000000",
    "source_order": ["main", "experimental"],
    "updated_at": "2026-02-05T10:00:00.000000"
  },
  "global_statistics": {
    "total_sources": 2,
    "total_queued": 5,
    "total_completed": 3,
    "total_failed": 0,
    "last_processed_at": "2026-02-05T10:05:00.000000"
  },
  "updated_at": "2026-02-05T10:00:00.000000"
}
```

## Directory Structure

```
~/.config/task-queue/          # Configuration directory
â”œâ”€â”€ config.json                  # Main configuration
â””â”€â”€ state/                       # State directory
    â””â”€â”€ queue_state.json        # Task queue state (v2.0)

{project-workspace}/            # Your project workspace
â””â”€â”€ tasks/
    â”œâ”€â”€ task-documents/         # Task Source Directory
    â”‚   â”œâ”€â”€ task-001.md
    â”‚   â””â”€â”€ task-002.md
    â”œâ”€â”€ task-archive/           # Completed task documents
    â””â”€â”€ task-queue/             # Result JSON files (flat)
        â””â”€â”€ task-<id>.json     # Individual task results
```

## Task Document Format

### Naming Convention

```
task-YYYYMMDD-HHMMSS-description.md
```

Components:
- `task-` - Required prefix
- `YYYYMMDD` - Date (8 digits)
- `HHMMSS` - Time (6 digits)
- `description` - Hyphen-separated description (optional but recommended)

### Example

```markdown
# Task: Fix authentication timeout

## Task
The authentication system times out after 30 seconds. Investigate and fix the timeout issue.

## Expected Outcome
- Authentication completes within 10 seconds
- Error handling for timeout scenarios
- Unit tests for timeout scenarios
```

## Daemon Service

### Service Management

```bash
# Enable at login
systemctl --user enable task-queue

# Start/stop/restart
systemctl --user start task-queue
systemctl --user stop task-queue
systemctl --user restart task-queue

# Check status
systemctl --user status task-queue
```

### Viewing Logs

```bash
# Follow logs in real-time
journalctl --user -u task-queue -f

# View last 100 lines
journalctl --user -u task-queue -n 100

# View logs since today
journalctl --user -u task-queue --since today
```

### Log Examples

```
Feb 05 10:00:00 task-queue: ============================================================
Feb 05 10:00:00 task-queue: Task Queue Daemon Starting
Feb 05 10:00:00 task-queue: Configuration loaded from: ~/.config/task-queue/config.json
Feb 05 10:00:00 task-queue: Project Workspace: /home/admin/workspaces/datachat
Feb 05 10:00:00 task-queue: Task Source Directories: 1
Feb 05 10:00:00 task-queue:   - main: /home/admin/workspaces/datachat/tasks/task-documents
Feb 05 10:00:00 task-queue: Watchdog monitoring: 1 sources
Feb 05 10:00:00 task-queue: Processing loop started (event-driven with watchdog)
Feb 05 10:00:01 task-queue: Watchdog event: task-001.md in source 'main'
Feb 05 10:00:01 task-queue: âœ… Auto-loaded task: task-001.md
```

## Workflow Example

### Complete Workflow

```bash
# 1. Load tasks from a Task Source Directory
task-queue load --task-source-dir tasks/task-documents --project-workspace /home/admin/workspaces/datachat --source-id main

# 2. Check registered Task Source Directories
task-queue list-sources

# 3. Create task documents (watchdog auto-loads them)
# Create files like: task-20260205-120000-feature-x.md

# 4. Check queue
task-queue queue
# Output: ğŸ“‹ Queue Statistics: Pending: 2

# 5. Process tasks (manual)
task-queue process

# OR start daemon for automatic processing with watchdog
systemctl --user start task-queue

# 6. Monitor progress
journalctl --user -u task-queue -f
```

### Watchdog vs Manual Loading

| Approach | When to Use |
|----------|-------------|
| **Watchdog (auto)** | Production, continuous operation |
| **Manual Load** | One-off processing, testing, specific files |

## Task Execution

### Two-Agent Workflow

Each task is executed using a two-agent workflow via the `/task-worker` skill:

1. **Implementation Agent** - Executes the task specification
2. **Auditor Agent** - Reviews and verifies the implementation
3. **Automatic Iteration** - Re-runs if audit fails (max 3 iterations)
4. **Safety Checkpoint** - Git commit before starting
5. **Final Commit** - Commits approved work when complete

### Execution States

| State | Description |
|-------|-------------|
| `pending` | Task is queued, waiting to be processed |
| `running` | Task is currently being executed |
| `completed` | Task completed successfully |
| `failed` | Task failed after max attempts |
| `cancelled` | Task was cancelled |

### Task Sources

| Source | Description |
|--------|-------------|
| `load` | Loaded via manual `load` command |
| `manual` | Manually added single task |
| `api` | Added via API (future) |
| `watchdog` | Auto-loaded by watchdog file event |
| `reload` | Loaded via `reload` command |

## Troubleshooting

### Common Issues

#### Issue: "No Project Workspace set"

```bash
# Solution: Include project-workspace parameter
task-queue load --task-source-dir <path> --project-workspace /path/to/project --source-id main
```

#### Issue: "No Task Source Directories configured"

```bash
# Solution: Load command auto-registers the source
task-queue load --task-source-dir <path> --project-workspace /path/to/project --source-id main
```

#### Issue: Daemon shows "No pending tasks"

```bash
# Solution: Create task documents or reload
# Watchdog will auto-load new files
# Or use reload command:
task-queue reload --task-source-dir main --project-workspace /path/to/project
```

#### Issue: Task failed

```bash
# Check queue for error details
task-queue queue

# Check result file
cat tasks/task-queue/task-<id>.json

# View daemon logs
journalctl --user -u task-queue -n 50
```

### Resetting the Queue

```bash
# Stop daemon first
systemctl --user stop task-queue

# Clear state file
rm ~/.config/task-queue/state/queue_state.json

# Restart daemon
systemctl --user start task-queue
```

## Development

### Project Structure

```
task-queue/
â”œâ”€â”€ task_queue/
â”‚   â”œâ”€â”€ __init__.py           # Package exports
â”‚   â”œâ”€â”€ atomic.py             # AtomicFileWriter, FileLock
â”‚   â”œâ”€â”€ cli.py                # CLI commands
â”‚   â”œâ”€â”€ config.py             # ConfigManager
â”‚   â”œâ”€â”€ daemon.py             # Daemon service with watchdog
â”‚   â”œâ”€â”€ executor.py           # Claude Agent SDK executor
â”‚   â”œâ”€â”€ models.py             # Pydantic models (v2.0)
â”‚   â”œâ”€â”€ monitor.py            # Main monitor orchestrator
â”‚   â”œâ”€â”€ processor.py          # Per-source task processor
â”‚   â”œâ”€â”€ scanner.py            # Task document scanner
â”‚   â”œâ”€â”€ coordinator.py        # Source coordinator (round-robin)
â”‚   â””â”€â”€ watchdog.py           # File system event monitoring
â”œâ”€â”€ tests/                    # Unit tests
â”‚   â”œâ”€â”€ test_atomic.py
â”‚   â”œâ”€â”€ test_config.py
â”‚   â”œâ”€â”€ test_executor.py
â”‚   â”œâ”€â”€ test_integration.py   # Integration tests
â”‚   â”œâ”€â”€ test_models.py
â”‚   â””â”€â”€ test_scanner.py
â”œâ”€â”€ README.md                 # This file
â”œâ”€â”€ pyproject.toml           # Python package config
â””â”€â”€ task-queue.service       # Systemd service file
```

### Running Tests

```bash
# Run all tests
python -m pytest tests/

# Run with coverage
python -m pytest --cov=task_queue tests/

# Run specific test file
python -m pytest tests/test_integration.py -v
```

## Migration from v1.0

### What Changed

1. **State structure** - Migrated from single global queue to per-source queues
2. **Terminology** - "Spec Directory" â†’ "Task Source Directory", "Project Path" â†’ "Project Workspace"
3. **CLI Commands** - Removed `set-project`, `add-doc`, `show-project`, `clear-project`
4. **Load Command** - Now requires both `--task-source-dir` and `--project-workspace` parameters
5. **New Commands** - Added `reload` and `unload`

### Automatic Migration

Existing v1.0 state files are automatically migrated to v2.0 format on first load. Tasks from the old single queue are distributed to per-source queues based on their `task_doc_dir_id` field.

## License

MIT License - See LICENSE file for details.

## Contributing

This is an internal project for the DataChat system. For questions or issues, please contact the development team.
